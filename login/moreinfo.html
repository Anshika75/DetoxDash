<!DOCTYPE html>
<html>

<head>
    <title>Login</title>
    <link rel="stylesheet" href="./login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <div class="login-splash-container">
        <div class="form-container">
            <h1><span style="color: #D3315A;">S</span>
                <span style="color: #00ADA9;">C</span>
                <span style="color: #7D5F91;">A</span>
                <span style="color: #EA872C;">L</span>
                <span style="color: #D3315A;">E</span></h1>
            <form id="loginForm">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" disabled>
                <label for="drugIndex">
                    Rate your addiction: 1-5 <a href=""><i class="fa-solid fa-book"></i></a>
                </label>
                <input type="range" name="drugIndex" id="drugIndex" min="0" max="5">

                <label>
                    Your current location
                </label>
                <button id="getLocationBtn" type="button">Get My Location</button>
                <p id="location"></p>
                <button>Submit</button>
            </form>
        </div>
        <button class="addPostBtn">Predict Addiction Level</button>
        <div class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Which of the following things you know?</h2>
                <div class="grid-container">
                    <div class="active"><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                    <div><img src="" alt=""></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-firestore.js"></script>

    <script src="../auth.js"></script>
    <script>
        var Curuser = null;
        let lat=0,lon=0;

        // check if user exists in database
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                console.log("User is signed in");
                Curuser = user;
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        email.value = doc.data().email;       
                    } else {
                        window.location.href = "./";
                    }
                }).catch((error) => {
                    console.log("Error getting document:", error);
                });
            } else {
                // User is signed out
                console.log("User is signed out");
            }
        });

        const loginForm = document.getElementById("loginForm");
        loginForm.addEventListener("submit",(e)=>{
            // update user info
            e.preventDefault();
            const drugIndex  = loginForm["drugIndex"].value
            // update those values in database where uid = Curuser.uid
            db.collection('users').doc(Curuser.uid).update({
                "index": drugIndex,
                location: {
                    latitude : lat,
                    longitude: lon
                }
            }).then(()=>{
                console.log("Profile Updated Successfully!");
                window.location.href = "./options";
            })
        })
        getLocationBtn.addEventListener("click",getLocation);
        function getLocation(e){
            e.preventDefault();
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(showPosition, (err)=>{
                    alert("Could not retrieve your location.");
                });
                function  showPosition(position){
                    var x=document.getElementById("location");
                    x.innerHTML="Latitude: "+ position.coords.latitude+" Longitude"+" "+position.coords.longitude;
                    lat = parseFloat(position.coords.latitude);
                    lon = parseFloat(position.coords.longitude);
                    x.innerHTML="Latitude: "+lat+"\tLongitude: " +lon;
                }
            }else{
                alert("Location is not supported by your device");
            }
        }
        
    </script>
</body>

</html>