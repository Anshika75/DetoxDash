<!DOCTYPE html>
<html>

<head>
    <title>Login</title>
    <link rel="stylesheet" href="./login.css">
</head>

<body>
    <div class="login-splash-container">
        <div class="form-container">
            <h1>
                <!-- final -->
                <span style="color: #b12f50;">F</span>
                <span style="color: #f2cf4a;">I</span>
                <span style="color: #74d577;">N</span>
                <span style="color: #b12f50;">A</span>
                <span style="color: #f2cf4a;">L</span>
            </h1>
            <h1><span style="color: #D3315A;">L</span>
                <span style="color: #00ADA9;">O</span>
                <span style="color: #7D5F91;">G</span>
                <span style="color: #EA872C;">I</span>
                <span style="color: #D3315A;">N</span></h1>
            <form id="loginForm">
                <!-- Enter some more info about yourself it will help us for customisation -->
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" disabled>
                <label for="drugIndex">
                    Rate your drug addiction on a scale of 1-10
                </label>
                <input type="range" name="drugIndex" id="drugIndex" min="0" max="5">

                <label>
                    Your current location
                </label>
                <button id="getLocationBtn" type="button">Get My Location</button>
                <p id="location"></p>
                <button>Submit</button>
            </form>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-firestore.js"></script>

    <script src="../auth.js"></script>
    <script>
        var Curuser = null;
        let lat=0,lon=0;

        // check if user exists in database
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                console.log("User is signed in");
                Curuser = user;
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        email.value = doc.data().email;       
                    } else {
                        window.location.href = "./";
                    }
                }).catch((error) => {
                    console.log("Error getting document:", error);
                });
            } else {
                // User is signed out
                console.log("User is signed out");
            }
        });

        const loginForm = document.getElementById("loginForm");
        loginForm.addEventListener("submit",(e)=>{
            // update user info
            e.preventDefault();
            const drugIndex  = loginForm["drugIndex"].value
            // update those values in database where uid = Curuser.uid
            db.collection('users').doc(Curuser.uid).update({
                "index": drugIndex,
                location: {
                    latitude : lat,
                    longitude: lon
                }
            }).then(()=>{
                console.log("Profile Updated Successfully!");
                window.location.href = "./options";
            })
        })
        getLocationBtn.addEventListener("click",getLocation);
        function getLocation(e){
            e.preventDefault();
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(showPosition, (err)=>{
                    alert("Could not retrieve your location.");
                });
                function  showPosition(position){
                    var x=document.getElementById("location");
                    x.innerHTML="Latitude: "+ position.coords.latitude+" Longitude"+" "+position.coords.longitude;
                    lat = parseFloat(position.coords.latitude);
                    lon = parseFloat(position.coords.longitude);
                    x.innerHTML="Latitude: "+lat+"\tLongitude: " +lon;
                }
            }else{
                alert("Location is not supported by your device");
            }
        }
        
    </script>
</body>

</html>